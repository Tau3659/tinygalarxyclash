# 游戏代码结构文档

## 📋 概述

本文档详细说明了游戏代码的结构、模块职责和关键功能。

## 🏗️ 代码架构

### 文件：game.js (3580行)

虽然是单文件，但代码内部已经按照职责进行了逻辑分组：

```
game.js
├── 配置部分 (1-70行)
│   └── GameConfig - 游戏配置对象
│
├── 缩放系统 (71-148行)
│   └── ScaleManager - 缩放管理类
│
├── 游戏核心 (149-2595行)
│   └── DroneGame - 游戏主类
│       ├── 初始化方法
│       ├── 游戏循环
│       ├── 更新逻辑
│       ├── 渲染逻辑
│       ├── AI控制
│       └── 碰撞检测
│
├── 实体类 (2596-3850行)
│   ├── Base - 基地类
│   ├── Drone - 无人机类
│   ├── Projectile - 投射物类
│   └── Debris - 碎片类
│
└── 启动代码 (3851-3580行)
    └── 游戏初始化注释
```

## 📦 核心模块说明

### 1. GameConfig (配置模块)
**位置**: 第1-70行  
**职责**: 管理所有游戏常量和配置

**关键配置**:
- `modes`: 游戏模式配置 (1v1, 2v2, ffa)
- `colors`: 玩家颜色配置
- `difficulty`: AI难度配置 (easy, medium, hard)
- `baseWidth/baseHeight`: 基准分辨率

### 2. ScaleManager (缩放管理)
**位置**: 第71-148行  
**职责**: 处理不同屏幕尺寸的缩放适配

**关键方法**:
- `constructor()`: 计算缩放比例
- `scaleValue()`: 缩放数值
- `getScaledValues()`: 获取所有缩放后的游戏参数

**特性**:
- 自动检测移动/桌面设备
- 支持高DPI屏幕
- 移动端额外放大倍数

### 3. DroneGame (游戏核心)
**位置**: 第149-2595行  
**职责**: 游戏主逻辑协调器

#### 3.1 初始化系统
- `constructor()`: 初始化游戏对象
- `initWelcomeScreen()`: 绑定欢迎界面事件
- `startGame()`: 开始游戏
- `initGame()`: 初始化游戏状态

#### 3.2 游戏循环
- `gameLoop()`: 主游戏循环
- `update()`: 更新游戏状态
- `render()`: 渲染游戏画面

#### 3.3 玩家管理
- `createPlayer()`: 创建玩家
- `spawnDrone()`: 生成无人机
- `upgradeAttribute()`: 升级属性

#### 3.4 AI系统
- `updateAI()`: 更新AI逻辑
- `executeAIStrategy()`: 执行AI策略
- `executeProactiveAttack()`: 主动进攻
- `executeResourceCollection()`: 资源收集

#### 3.5 碰撞检测
- `checkCollisions()`: 检查所有碰撞
- `handleProjectileCollision()`: 处理投射物碰撞

#### 3.6 输入处理
- `bindGameEvents()`: 绑定输入事件
- `handleInteraction()`: 处理点击/触摸

#### 3.7 渲染系统
- `render()`: 主渲染方法
- `renderGameBackground()`: 渲染背景
- `renderStarfield()`: 渲染星空
- `renderEnhancedDrone()`: 渲染无人机
- `renderEnhancedProjectile()`: 渲染投射物

### 4. Base (基地类)
**位置**: 第2596-2666行  
**职责**: 管理基地实体

**属性**:
- 位置: x, y
- 生命值: health, maxHealth
- 状态: invulnerable

**方法**:
- `takeDamage()`: 受到伤害
- `upgradeHealth()`: 升级血量
- `render()`: 渲染基地

### 5. Drone (无人机类)
**位置**: 第2667-3737行  
**职责**: 管理无人机实体

**属性**:
- 位置和速度: x, y, vx, vy
- 战斗属性: health, damage, attackSpeed
- 目标: target, playerTarget, rallyPoint

**关键方法**:
- `update()`: 更新无人机状态
- `findTarget()`: 寻找攻击目标
- `move()`: 移动逻辑
- `attack()`: 攻击逻辑
- `applyBoids()`: 群体行为算法
- `render()`: 渲染无人机

### 6. Projectile (投射物类)
**位置**: 第3738-3793行  
**职责**: 管理投射物实体

**特性**:
- 对象池管理（性能优化）
- 轨迹效果
- 自动销毁

### 7. Debris (碎片类)
**位置**: 第3794-3850行  
**职责**: 管理资源碎片

**特性**:
- 旋转动画
- 脉冲效果
- 血量系统

## 🎯 关键功能实现

### 安全边界系统
**位置**: 第294-382行, 第1100-1125行  
**功能**: 防止游戏元素进入UI区域

**实现**:
- 桌面端：左侧边界
- 移动端：顶部边界
- 动态计算安全区域
- 点击重定向到安全区域

### 缩放系统
**位置**: 第71-148行  
**功能**: 适配不同屏幕尺寸

**实现**:
- 基于基准分辨率计算缩放比例
- 移动端额外放大
- 所有游戏元素统一缩放

### AI系统
**位置**: 第1126-1850行  
**功能**: 三种难度的AI对手

**难度特性**:
- **简单**: 被动防御，不升级
- **中等**: 偶尔进攻，50%资源升级
- **困难**: 主动进攻，预测性攻击，侧翼包抄

### 群体行为 (Boids)
**位置**: 第3216-3350行  
**功能**: 无人机群体智能移动

**三大规则**:
1. **分离**: 避免拥挤
2. **对齐**: 方向一致
3. **聚合**: 保持队形

## 🔧 性能优化

### 1. 对象池
**位置**: 第449-458行  
**用途**: 投射物复用，减少GC

### 2. 批量渲染
**位置**: 第2419-2435行  
**用途**: 按颜色分组渲染，减少状态切换

### 3. 帧率控制
**位置**: 第875-888行  
**用途**: 使用requestAnimationFrame

### 4. 更新频率控制
**位置**: 第890-920行  
**用途**: AI和UI更新降频

## 📊 数据流

```
用户输入
    ↓
InputManager (bindGameEvents)
    ↓
Game.update()
    ├→ 更新玩家
    ├→ 更新AI
    ├→ 更新无人机
    ├→ 更新投射物
    ├→ 碰撞检测
    └→ 检查胜利条件
    ↓
Game.render()
    ├→ 渲染背景
    ├→ 渲染实体
    └→ 渲染UI
    ↓
显示到屏幕
```

## 🐛 调试技巧

### 控制台日志
代码中包含大量console.log，可以追踪：
- 游戏初始化
- 无人机行为
- AI决策
- 碰撞事件

### 关键变量
- `game.gameState`: 游戏状态
- `game.players`: 玩家数组
- `game.frameCount`: 帧计数
- `game.scaledValues`: 缩放后的数值

## 📝 维护建议

### 修改配置
修改 `GameConfig` 对象即可调整游戏平衡

### 添加新功能
1. 在对应的类中添加方法
2. 在 `update()` 或 `render()` 中调用
3. 添加必要的配置到 `GameConfig`

### 修复Bug
1. 使用浏览器开发工具定位问题
2. 查看控制台日志
3. 在相关方法中添加断点

## 🎮 游戏流程

```
欢迎界面
    ↓
选择模式/难度/颜色
    ↓
开始游戏
    ↓
初始化玩家和无人机
    ↓
游戏循环
    ├→ 玩家操作
    ├→ AI决策
    ├→ 战斗
    └→ 资源收集
    ↓
检查胜利条件
    ↓
游戏结束界面
```

## 总结

虽然代码在单个文件中，但通过清晰的类结构和注释，已经实现了良好的模块化。每个类都有明确的职责，代码逻辑清晰，易于维护和扩展。
