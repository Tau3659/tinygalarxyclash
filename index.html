<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#000000">
    <title>Tiny Galaxy Clash</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #fff;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
        }
        
        /* 加载页面样式 */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        
        #loadingScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-logo {
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            margin-bottom: 40px;
        }
        
        .loading-container {
            width: 400px;
            max-width: 80vw;
            text-align: center;
        }
        
        .loading-text {
            font-size: 18px;
            color: #ccc;
            margin-bottom: 20px;
            min-height: 24px;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #81C784);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }
        
        .progress-percentage {
            font-size: 16px;
            color: #4CAF50;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .loading-details {
            font-size: 14px;
            color: #888;
            min-height: 20px;
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .loading-logo {
                font-size: 36px;
                margin-bottom: 30px;
            }
            
            .loading-container {
                width: 300px;
            }
            
            .loading-text {
                font-size: 16px;
            }
        }
        
        #welcomeScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0a1a; /* 深色背景，避免白屏 */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none; /* 初始隐藏，加载完成后显示 */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow: hidden;
            transition: background-image 0.5s ease-in-out; /* 平滑过渡 */
        }
        
        #welcomeScreen.show {
            display: flex;
        }
        
        /* 背景图加载完成后的样式 */
        #welcomeScreen.bg-loaded {
            background-image: url('assets/images/backgrounds/space_background.jpg');
        }
        
        /* 加载提示样式 */
        .loading-hint {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-hint.hidden {
            opacity: 0;
        }
        
        /* 设置按钮样式 */
        .settings-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 移动端设置按钮适配 */
        @media (max-width: 768px) and (hover: none) {
            .settings-btn {
                top: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .settings-btn:active {
                background: rgba(255, 255, 255, 0.3);
                transform: scale(0.95);
            }
        }
        
        /* 超小屏幕设置按钮适配 */
        @media (max-width: 480px) and (hover: none) {
            .settings-btn {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }
        
        /* 设置弹窗样式 */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .settings-panel {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.95), rgba(40, 40, 80, 0.95));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            width: 400px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        .settings-title {
            color: white;
            font-size: 24px;
            text-align: center;
            margin-bottom: 30px;
            font-weight: bold;
        }
        
        .setting-item {
            margin-bottom: 25px;
            color: white;
        }
        
        .setting-label {
            display: block;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .setting-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch.active {
            background: #4CAF50;
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }
        
        .volume-slider {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }
        
        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .volume-value {
            min-width: 40px;
            text-align: center;
            font-size: 14px;
        }
        
        /* 移动端设置窗口适配 */
        @media (max-width: 768px) and (hover: none) {
            .settings-panel {
                width: 90vw;
                max-width: 350px;
                padding: 20px;
                border-radius: 15px;
                margin: 10px;
            }
            
            .settings-title {
                font-size: 20px;
                margin-bottom: 20px;
            }
            
            .setting-item {
                margin-bottom: 20px;
            }
            
            .setting-label {
                font-size: 15px;
                margin-bottom: 8px;
            }
            
            .setting-controls {
                gap: 12px;
            }
            
            .toggle-switch {
                width: 50px;
                height: 26px;
                border-radius: 13px;
            }
            
            .toggle-slider {
                width: 20px;
                height: 20px;
                top: 3px;
                left: 3px;
            }
            
            .toggle-switch.active .toggle-slider {
                transform: translateX(24px);
            }
            
            .volume-slider {
                height: 8px;
                border-radius: 4px;
            }
            
            .volume-slider::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }
            
            .volume-value {
                min-width: 35px;
                font-size: 13px;
            }
            
            .close-btn {
                padding: 12px 24px;
                font-size: 15px;
                border-radius: 8px;
                margin-top: 15px;
            }
        }
        
        /* 超小屏幕适配 */
        @media (max-width: 480px) and (hover: none) {
            .settings-panel {
                width: 95vw;
                max-width: 320px;
                padding: 15px;
            }
            
            .settings-title {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            .setting-item {
                margin-bottom: 15px;
            }
            
            .setting-label {
                font-size: 14px;
                margin-bottom: 6px;
            }
            
            .setting-controls {
                gap: 10px;
            }
            
            .toggle-switch {
                width: 45px;
                height: 24px;
                border-radius: 12px;
            }
            
            .toggle-slider {
                width: 18px;
                height: 18px;
                top: 3px;
                left: 3px;
            }
            
            .toggle-switch.active .toggle-slider {
                transform: translateX(21px);
            }
            
            .volume-value {
                min-width: 30px;
                font-size: 12px;
            }
            
            .close-btn {
                padding: 10px 20px;
                font-size: 14px;
                margin-top: 10px;
            }
        }
        
        .close-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }
        
        .welcome-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
            z-index: 10;
            position: relative;
            background: linear-gradient(45deg, #00ffff, #87ceeb, #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .mode-selection {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            z-index: 10;
            position: relative;
        }
        
        .mode-btn {
            background: linear-gradient(45deg, rgba(33, 150, 243, 0.8), rgba(33, 203, 243, 0.8));
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 20px 40px;
            font-size: 18px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3), 0 0 20px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .mode-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .mode-btn:hover::before {
            left: 100%;
        }
        
        .mode-btn:active {
            transform: translateY(-2px) scale(1.02);
        }
        
        .color-selection {
            margin-bottom: 30px;
            z-index: 10;
            position: relative;
        }
        
        .color-title {
            font-size: 20px;
            margin-bottom: 15px;
            text-align: center;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }
        
        .color-options {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .color-btn {
            width: 50px;
            height: 50px;
            border: 3px solid #fff;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .color-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        
        .color-btn.selected {
            border-color: #ffffff;
            /* 发光颜色将通过JavaScript动态设置 */
        }
        
        .start-btn {
            background: linear-gradient(45deg, rgba(76, 175, 80, 0.9), rgba(69, 160, 73, 0.9));
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 50px;
            font-size: 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3), 0 0 20px rgba(255, 255, 255, 0.1);
            z-index: 10;
            position: relative;
        }
        
        .start-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
        }
        
        /* 禁用状态：简单的置灰处理 */
        .start-btn:disabled {
            background: linear-gradient(45deg, rgba(128, 128, 128, 0.4), rgba(100, 100, 100, 0.4));
            color: rgba(255, 255, 255, 0.6);
            cursor: not-allowed;
            box-shadow: 0 2px 8px rgba(128, 128, 128, 0.2);
        }
        
        .preview-section {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        
        .preview-btn {
            background: linear-gradient(45deg, #9C27B0, #E91E63);
            border: none;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .preview-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .preview-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.5);
        }
        
        .preview-btn:hover::before {
            left: 100%;
        }
        
        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            z-index: 1;
        }
        
        #ui {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
            display: none; /* 默认隐藏，只在游戏开始时显示 */
            pointer-events: auto;
            width: 240px; /* 增加宽度以更好利用空间 */
        }
        
        /* 桌面端UI布局 - 默认样式 */
        .mobile-ui-container {
            display: block; /* 桌面端使用默认块级布局 */
        }
        
        /* 基础信息面板 */
        .info-panel {
            background: linear-gradient(145deg, rgba(0, 20, 40, 0.95), rgba(0, 30, 60, 0.95));
            backdrop-filter: blur(12px);
            padding: 15px; /* 增加内边距 */
            border-radius: 10px; /* 稍微增加圆角 */
            margin-bottom: 12px; /* 增加间距 */
            border: 1px solid rgba(100, 200, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            min-width: 200px; /* 确保最小宽度 */
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px; /* 减小行间距 */
            padding: 1px 0; /* 减小内边距 */
        }
        
        .info-row:last-child {
            margin-bottom: 0;
        }
        
        .info-label {
            color: #a0aec0;
            font-size: 14px; /* 稍微增大字体 */
            font-weight: 500;
            min-width: 60px; /* 确保标签有足够宽度 */
        }
        
        .info-value {
            color: #e2e8f0;
            font-size: 15px; /* 稍微增大字体 */
            font-weight: 600;
            min-width: 50px; /* 增加最小宽度 */
            text-align: right;
        }
        
        .info-value.highlight {
            color: #00ff88;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.3);
        }
        
        .info-max {
            color: #718096;
            font-size: 14px; /* 稍微增大字体 */
        }
        
        /* 升级面板 */
        .upgrade-panel {
            background: linear-gradient(145deg, rgba(0, 20, 40, 0.95), rgba(0, 30, 60, 0.95));
            backdrop-filter: blur(12px);
            padding: 15px; /* 增加内边距 */
            border-radius: 10px; /* 稍微增加圆角 */
            margin-bottom: 12px; /* 增加间距 */
            border: 1px solid rgba(100, 200, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            min-width: 200px; /* 确保最小宽度 */
        }
        
        .panel-title {
            color: #cbd5e0;
            font-size: 15px; /* 稍微增大字体 */
            font-weight: 600;
            margin-bottom: 10px; /* 增加间距 */
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 6px; /* 增加内边距 */
        }
        
        /* 桌面端升级按钮容器 - 默认垂直布局 */
        .upgrade-buttons-container {
            display: block;
        }
        
        .upgrade-buttons-row {
            display: block;
        }
        
        .upgrade-btn {
            background: linear-gradient(45deg, rgba(74, 85, 104, 0.8), rgba(45, 55, 72, 0.8));
            color: #e2e8f0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 15px; /* 增加内边距 */
            margin-bottom: 6px; /* 增加间距 */
            cursor: pointer;
            border-radius: 8px; /* 稍微增加圆角 */
            font-size: 14px; /* 稍微增大字体 */
            font-weight: 500;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            box-sizing: border-box;
            min-height: 40px; /* 确保按钮有足够高度 */
        }
        
        .upgrade-btn:hover {
            background: linear-gradient(45deg, rgba(74, 85, 104, 1), rgba(45, 55, 72, 1));
            border-color: rgba(100, 200, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .upgrade-btn:active {
            transform: translateY(0);
        }
        
        .upgrade-btn:disabled {
            background: linear-gradient(45deg, rgba(45, 55, 72, 0.5), rgba(26, 32, 44, 0.5));
            cursor: not-allowed;
            opacity: 0.6;
            transform: none;
        }
        
        .level-display {
            color: #ffd700;
            font-weight: 600;
            text-shadow: 0 0 6px rgba(255, 215, 0, 0.3);
            font-size: 14px; /* 明确设置字体大小 */
        }
        
        /* 游戏控制按钮样式 */
        .game-control-panel .upgrade-buttons-container {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        
        .control-btn {
            background: linear-gradient(45deg, rgba(74, 85, 104, 0.8), rgba(45, 55, 72, 0.8));
            color: #e2e8f0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            flex: 1;
            min-height: 36px;
        }
        
        .control-btn:hover {
            background: linear-gradient(45deg, rgba(74, 85, 104, 1), rgba(45, 55, 72, 1));
            border-color: rgba(100, 200, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .control-btn:active {
            transform: translateY(0);
        }
        
        .pause-btn {
            background: linear-gradient(45deg, rgba(59, 130, 246, 0.8), rgba(37, 99, 235, 0.8));
        }
        
        .pause-btn:hover {
            background: linear-gradient(45deg, rgba(59, 130, 246, 1), rgba(37, 99, 235, 1));
        }
        
        .pause-btn.paused {
            background: linear-gradient(45deg, rgba(34, 197, 94, 0.8), rgba(22, 163, 74, 0.8));
        }
        
        .pause-btn.paused:hover {
            background: linear-gradient(45deg, rgba(34, 197, 94, 1), rgba(22, 163, 74, 1));
        }
        
        .surrender-btn {
            background: linear-gradient(45deg, rgba(239, 68, 68, 0.8), rgba(220, 38, 38, 0.8));
        }
        
        .surrender-btn:hover {
            background: linear-gradient(45deg, rgba(239, 68, 68, 1), rgba(220, 38, 38, 1));
        }
        
        .pause-icon, .surrender-icon {
            font-size: 14px;
        }
        
        .pause-text, .surrender-text {
            font-size: 13px;
        }
        
        /* 投降确认弹窗样式 */
        .surrender-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 10000;
        }
        
        .surrender-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            cursor: default; /* 明确显示这里不可点击 */
        }
        
        .surrender-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(50, 50, 80, 0.95));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            text-align: center;
            cursor: default; /* 确保弹窗内容区域有正确的光标 */
        }
        
        .surrender-title {
            color: #ff6b6b;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }
        
        .surrender-message {
            color: #e2e8f0;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 30px;
        }
        
        .surrender-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .surrender-confirm-btn, .surrender-cancel-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }
        
        .surrender-confirm-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .surrender-confirm-btn:hover {
            background: linear-gradient(45deg, #ff5252, #e53935);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        .surrender-cancel-btn {
            background: linear-gradient(45deg, #64748b, #475569);
            color: white;
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }
        
        .surrender-cancel-btn:hover {
            background: linear-gradient(45deg, #475569, #334155);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
        }
        
        /* 移动端弹窗适配 */
        @media (max-width: 768px) {
            .surrender-dialog {
                padding: 20px;
                min-width: 280px;
                margin: 20px;
            }
            
            .surrender-title {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            .surrender-message {
                font-size: 14px;
                margin-bottom: 25px;
            }
            
            .surrender-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .surrender-confirm-btn, .surrender-cancel-btn {
                padding: 12px 20px;
                font-size: 14px;
                width: 100%;
            }
        }
        
        /* 暂停弹窗样式 */
        .pause-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 10000;
        }
        
        .pause-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            cursor: default; /* 明确显示这里不可点击 */
        }
        
        .pause-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(30, 30, 50, 0.95), rgba(50, 50, 80, 0.95));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            text-align: center;
            cursor: default; /* 确保弹窗内容区域有正确的光标 */
        }
        
        .pause-title {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }
        
        .pause-timer {
            color: #e2e8f0;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 30px;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .pause-buttons {
            display: flex;
            justify-content: center;
        }
        
        .pause-resume-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .pause-resume-btn:hover {
            background: linear-gradient(45deg, #45a049, #3d8b40);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        /* 移动端暂停弹窗适配 */
        @media (max-width: 768px) {
            .pause-dialog {
                padding: 20px;
                min-width: 280px;
                margin: 20px;
            }
            
            .pause-title {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            .pause-timer {
                font-size: 16px;
                margin-bottom: 25px;
                padding: 8px 16px;
            }
            
            .pause-resume-btn {
                padding: 12px 20px;
                font-size: 14px;
                width: 100%;
            }
        }
        
        /* 桌面端小窗口适配 - 保持左侧布局但调整尺寸 */
        @media (max-width: 1200px) and (pointer: fine) {
            /* 只在鼠标设备上生效，避免影响触摸设备 */
            #ui {
                width: 200px !important; /* 减小面板宽度 */
            }
            
            .info-panel, .upgrade-panel {
                padding: 10px !important; /* 减小内边距 */
                min-width: 180px !important; /* 调整最小宽度 */
            }
            
            .info-label {
                font-size: 12px !important; /* 减小字体 */
                min-width: 50px !important; /* 减小最小宽度 */
            }
            
            .info-value {
                font-size: 13px !important; /* 减小字体 */
                min-width: 40px !important; /* 减小最小宽度 */
            }
            
            .info-max {
                font-size: 12px !important; /* 减小字体 */
            }
            
            .panel-title {
                font-size: 13px !important; /* 减小字体 */
            }
            
            .upgrade-btn {
                padding: 8px 10px !important; /* 减小内边距 */
                font-size: 12px !important; /* 减小字体 */
                min-height: 35px !important; /* 减小按钮高度 */
            }
            
            .level-display {
                font-size: 12px !important; /* 减小字体 */
            }
        }
        
        @media (max-width: 900px) and (pointer: fine) {
            /* 更小的桌面窗口 */
            #ui {
                width: 180px !important; /* 进一步减小宽度 */
            }
            
            .info-panel, .upgrade-panel {
                padding: 8px !important; /* 进一步减小内边距 */
                min-width: 160px !important; /* 调整最小宽度 */
            }
            
            .info-label {
                font-size: 11px !important; /* 进一步减小字体 */
                min-width: 45px !important;
            }
            
            .info-value {
                font-size: 12px !important; /* 进一步减小字体 */
                min-width: 35px !important;
            }
            
            .upgrade-btn {
                padding: 6px 8px !important; /* 进一步减小内边距 */
                font-size: 11px !important; /* 进一步减小字体 */
                min-height: 30px !important; /* 进一步减小按钮高度 */
            }
        }
        
        /* 移动端适配样式 - 使用更精确的检测 */
        @media (max-width: 768px) and (hover: none) {
            /* 这个媒体查询检测不支持hover的设备（通常是触摸设备） */
            /* 欢迎界面移动端优化 - 整体居中 */
            #welcomeScreen {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
            }
            
            .welcome-title {
                font-size: 32px;
                margin-bottom: 20px;
                text-align: center;
                padding: 0 20px;
                width: 100%;
                max-width: 500px;
            }
            
            /* 游戏模式选择 - 根据屏幕宽度调整 */
            .mode-selection {
                margin-bottom: 25px;
                width: 100%;
                max-width: 500px;
                display: flex;
                gap: 15px;
            }
            
            /* 屏幕宽度小于400px：垂直排列 */
            @media (max-width: 399px) {
                .mode-selection {
                    flex-direction: column;
                    align-items: center;
                }
                
                .mode-btn {
                    width: 100%;
                    max-width: 280px;
                    padding: 15px 25px;
                    font-size: 16px;
                    box-sizing: border-box;
                }
            }
            
            /* 屏幕宽度400px及以上：水平排列，等分宽度 */
            @media (min-width: 400px) {
                .mode-selection {
                    flex-direction: row;
                    justify-content: space-between;
                }
                
                .mode-btn {
                    flex: 1;
                    padding: 15px 10px;
                    font-size: 14px;
                    box-sizing: border-box;
                    min-width: 0; /* 防止文字溢出 */
                }
            }
            
            /* 颜色选择区域 */
            .color-selection {
                margin-bottom: 20px;
                width: 100%;
                max-width: 500px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            .color-title {
                font-size: 18px;
                margin-bottom: 12px;
                text-align: center;
            }
            
            .color-options {
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
                display: flex;
            }
            
            .color-btn {
                width: 40px;
                height: 40px;
            }
            
            /* AI难度选择 - 同样根据屏幕宽度调整 */
            .color-selection:last-of-type .mode-selection {
                margin-bottom: 0;
            }
            
            /* 开始按钮 */
            .start-btn {
                padding: 12px 40px;
                font-size: 18px;
                margin-top: 10px;
                width: auto;
                max-width: 300px;
            }
            
            .preview-section {
                position: fixed;
                top: 10px;
                right: 10px;
            }
            
            .preview-btn {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            /* ===== 移动端游戏UI样式重写 ===== */
            /* 重置桌面端样式，应用移动端布局 */
            #ui {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: auto !important;
                background: linear-gradient(180deg, rgba(0, 20, 40, 0.95) 0%, rgba(0, 20, 40, 0.85) 100%);
                backdrop-filter: blur(15px);
                border-bottom: 2px solid rgba(100, 200, 255, 0.3);
                box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
                z-index: 1000;
                padding: 1vh 2vw;
                box-sizing: border-box;
                /* 重要：保持默认隐藏状态，只有JavaScript控制显示 */
                display: none !important;
            }
            
            /* 当游戏开始时，通过JavaScript设置为flex */
            #ui.game-active {
                display: flex !important;
            }
            
            .mobile-ui-container {
                display: flex !important;
                width: 100%;
                gap: 1vw;
                align-items: stretch;
            }
            
            /* 屏幕宽度小于400px：垂直排列3个面板 */
            @media (max-width: 399px) {
                #ui {
                    height: auto !important; /* 自动高度 */
                    min-height: 180px !important; /* 增加高度，确保按钮不超出 */
                    max-height: 250px !important; /* 增加最大高度 */
                    padding: 1vh 2vw !important; /* 使用百分比内边距 */
                    left: 0 !important;
                    right: 0 !important;
                    width: 100vw !important; /* 占满整个视口宽度 */
                    box-sizing: border-box !important;
                }
                
                .mobile-ui-container {
                    flex-direction: column !important;
                    gap: 1vh !important; /* 增加间距 */
                    width: 100% !important;
                    max-width: 100% !important;
                }
                
                /* 信息面板 - 垂直排列时占满宽度 */
                .info-panel {
                    flex: none !important;
                    width: 100% !important;
                    padding: 1vh 2vw !important; /* 增加内边距 */
                    margin: 0 !important;
                    border-radius: 1vw !important;
                    display: grid !important;
                    grid-template-columns: 1fr 1fr !important;
                    gap: 2vw !important; /* 增加间距 */
                    align-items: center !important;
                    box-sizing: border-box !important;
                }
                
                /* 无人机升级面板 */
                .drone-upgrade-panel {
                    flex: none !important;
                    width: 100% !important;
                    padding: 1vh 2vw !important; /* 增加内边距 */
                    margin: 0 !important;
                    border-radius: 1vw !important;
                    display: flex !important;
                    flex-direction: column !important;
                    box-sizing: border-box !important;
                    min-height: 8vh !important; /* 确保足够高度 */
                }
                
                /* 基地升级面板 */
                .base-upgrade-panel {
                    flex: none !important;
                    width: 100% !important;
                    padding: 1vh 2vw !important; /* 增加内边距 */
                    margin: 0 !important;
                    border-radius: 1vw !important;
                    display: flex !important;
                    flex-direction: column !important;
                    box-sizing: border-box !important;
                    min-height: 4vh !important; /* 确保足够高度 */
                }
                
                /* 游戏控制面板 */
                .game-control-panel {
                    flex: none !important;
                    width: 100% !important;
                    padding: 1vh 2vw !important;
                    margin: 0 !important;
                    border-radius: 1vw !important;
                    display: flex !important;
                    flex-direction: column !important;
                    box-sizing: border-box !important;
                    min-height: 4vh !important;
                }
                
                .info-row {
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                    margin: 0 !important;
                    padding: 0.1vh 0 !important; /* 减小移动端间距 */
                    min-height: 1.8vh !important; /* 减小最小高度 */
                }
                
                /* 无人机升级按钮 - 2×2网格 */
                .drone-upgrade-panel .upgrade-buttons-container {
                    display: grid !important;
                    grid-template-columns: 1fr 1fr !important;
                    gap: 1vw !important; /* 增加间距 */
                    flex: 1 !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                }
                
                .drone-upgrade-panel .upgrade-buttons-row {
                    display: contents !important; /* 让子元素直接参与grid布局 */
                }
                
                /* 基地升级按钮 - 单个按钮 */
                .base-upgrade-panel .upgrade-buttons-container {
                    display: flex !important;
                    flex: 1 !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                }
                
                /* 游戏控制按钮 - 水平排列 */
                .game-control-panel .upgrade-buttons-container {
                    display: flex !important;
                    gap: 1vw !important;
                    flex: 1 !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                }
                
                .control-btn {
                    padding: 1vh 1.5vw !important;
                    font-size: 2.8vw !important;
                    min-height: 3.5vh !important;
                    flex: 1 !important;
                    gap: 0.8vw !important;
                }
                
                .pause-icon, .surrender-icon {
                    font-size: 3.2vw !important;
                }
                
                .pause-text, .surrender-text {
                    font-size: 2.6vw !important;
                }
                
                .upgrade-btn {
                    margin-bottom: 0 !important;
                    min-height: 3.5vh !important; /* 增加按钮高度 */
                    padding: 0.8vh 1vw !important; /* 增加内边距 */
                    font-size: 2.5vw !important; /* 稍微增大字体 */
                    border-radius: 1vw !important;
                    box-sizing: border-box !important;
                    overflow: hidden !important;
                    text-overflow: ellipsis !important;
                    white-space: nowrap !important;
                    width: 100% !important;
                }
            }
            
            /* 屏幕宽度400px及以上：水平排列3个面板，等分屏幕宽度 */
            @media (min-width: 400px) {
                #ui {
                    height: 15vh !important; /* 增加高度 */
                    min-height: 100px !important; /* 增加最小高度 */
                    max-height: 140px !important; /* 增加最大高度 */
                    padding: 1vh 1vw !important; /* 使用百分比内边距 */
                    left: 0 !important;
                    right: 0 !important;
                    width: 100vw !important; /* 占满整个视口宽度 */
                    box-sizing: border-box !important;
                }
                
                .mobile-ui-container {
                    flex-direction: row !important;
                    gap: 1vw !important; /* 使用百分比间距 */
                    width: 100% !important;
                    height: 100% !important;
                }
                
                /* 信息面板 - 占30%宽度 */
                .info-panel {
                    flex: 0 0 30% !important; /* 30%宽度 */
                    padding: 1vh 1vw !important;
                    margin: 0 !important;
                    border-radius: 1vw !important;
                    min-height: 0 !important;
                    display: flex !important;
                    flex-direction: column !important;
                    justify-content: space-between !important;
                    min-width: 0 !important;
                    box-sizing: border-box !important;
                }
                
                /* 无人机升级面板 - 占40%宽度 */
                .drone-upgrade-panel {
                    flex: 0 0 40% !important; /* 40%宽度 */
                    padding: 1vh 1vw !important;
                    margin: 0 !important;
                    border-radius: 1vw !important;
                    min-height: 0 !important;
                    display: flex !important;
                    flex-direction: column !important;
                    min-width: 0 !important;
                    box-sizing: border-box !important;
                }
                
                /* 基地升级面板 - 占28%宽度 */
                .base-upgrade-panel {
                    flex: 0 0 28% !important; /* 28%宽度，总计98% + 2%间距 = 100% */
                    padding: 1vh 1vw !important;
                    margin: 0 !important;
                    border-radius: 1vw !important;
                    min-height: 0 !important;
                    display: flex !important;
                    flex-direction: column !important;
                    min-width: 0 !important;
                    box-sizing: border-box !important;
                    justify-content: center !important; /* 基地面板内容居中 */
                }
                
                .info-row {
                    display: flex !important;
                    justify-content: space-between !important;
                    align-items: center !important;
                    margin-bottom: 0.3vh !important;
                    padding: 0.2vh 0 !important;
                    min-height: 2vh !important;
                }
                
                .info-row:last-child {
                    margin-bottom: 0 !important;
                }
                
                /* 无人机升级按钮容器 - 2×2网格 */
                .drone-upgrade-panel .upgrade-buttons-container {
                    display: grid !important;
                    grid-template-columns: 1fr 1fr !important;
                    gap: 0.8vw !important;
                    flex: 1 !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                }
                
                .drone-upgrade-panel .upgrade-buttons-row {
                    display: contents !important; /* 让子元素直接参与grid布局 */
                }
                
                /* 基地升级按钮容器 - 单个按钮 */
                .base-upgrade-panel .upgrade-buttons-container {
                    display: flex !important;
                    flex: 1 !important;
                    align-items: center !important;
                    width: 100% !important;
                    box-sizing: border-box !important;
                }
                
                .upgrade-btn {
                    margin-bottom: 0 !important;
                    min-height: 3.5vh !important; /* 增加按钮高度 */
                    padding: 0.8vh 1vw !important; /* 增加内边距 */
                    font-size: 2.2vw !important;
                    border-radius: 1vw !important;
                    box-sizing: border-box !important;
                    overflow: hidden !important;
                    text-overflow: ellipsis !important;
                    white-space: nowrap !important;
                    width: 100% !important;
                }
            }
            
            /* 移动端字体和样式重写 */
            .info-label {
                font-size: 2.8vw !important; /* 稍微增大字体 */
                color: #a0aec0 !important;
                font-weight: 500 !important;
            }
            
            .info-value {
                font-size: 3.2vw !important; /* 稍微增大字体 */
                color: #e2e8f0 !important;
                font-weight: 600 !important;
                min-width: 8vw !important;
                text-align: right !important;
            }
            
            .info-value.highlight {
                color: #00ff88 !important;
                text-shadow: 0 0 6px rgba(0, 255, 136, 0.3) !important;
            }
            
            .info-max {
                font-size: 2.5vw !important;
                color: #718096 !important;
            }
            
            .panel-title {
                font-size: 3vw !important;
                font-weight: 600 !important;
                margin-bottom: 0.4vh !important;
                text-align: center !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
                padding-bottom: 0.2vh !important;
                color: #cbd5e0 !important;
            }
            
            .upgrade-btn {
                background: linear-gradient(45deg, rgba(74, 85, 104, 0.8), rgba(45, 55, 72, 0.8)) !important;
                color: #e2e8f0 !important;
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                padding: 0.6vh 0.8vw !important;
                margin-bottom: 0.2vh !important;
                cursor: pointer !important;
                border-radius: 0.6vw !important;
                font-size: 2.4vw !important; /* 调整字体大小 */
                font-weight: 500 !important;
                width: 100% !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                transition: all 0.2s ease !important;
                min-height: 3vh !important; /* 减少最小高度 */
                box-sizing: border-box !important;
                overflow: hidden !important; /* 防止内容溢出 */
                text-overflow: ellipsis !important; /* 文字溢出显示省略号 */
                white-space: nowrap !important; /* 防止文字换行 */
            }
            
            .level-display {
                color: #ffd700 !important;
                font-weight: 600 !important;
                text-shadow: 0 0 4px rgba(255, 215, 0, 0.3) !important;
                font-size: 2vw !important;
                flex-shrink: 0 !important; /* 防止等级显示被压缩 */
            }
        }
        
        /* 超小屏幕适配 */
        @media (max-width: 480px) {
            /* 欢迎界面超小屏幕优化 */
            #welcomeScreen {
                padding: 15px;
            }
            
            .welcome-title {
                font-size: 28px;
                margin-bottom: 15px;
                padding: 0 10px;
            }
            
            .mode-selection {
                margin-bottom: 20px;
                gap: 12px;
            }
            
            /* 超小屏幕按钮优化 */
            @media (max-width: 399px) {
                .mode-btn {
                    padding: 12px 20px;
                    font-size: 15px;
                    max-width: 250px;
                }
            }
            
            @media (min-width: 400px) and (max-width: 480px) {
                .mode-btn {
                    padding: 12px 8px;
                    font-size: 13px;
                }
            }
            
            .color-title {
                font-size: 16px;
            }
            
            .color-btn {
                width: 35px;
                height: 35px;
            }
            
            .start-btn {
                padding: 10px 30px;
                font-size: 16px;
                max-width: 250px;
            }
            
            /* 游戏UI超小屏幕优化 */
            @media (max-width: 399px) {
                #ui {
                    min-height: 120px !important;
                    max-height: 160px !important;
                    padding: 0.8vh 1.5vw;
                }
                
                .info-label {
                    font-size: 3vw !important;
                }
                
                .info-value {
                    font-size: 3.5vw !important;
                    min-width: 8vw;
                }
                
                .info-max {
                    font-size: 2.8vw !important;
                }
                
                .panel-title {
                    font-size: 3.2vw !important;
                    margin-bottom: 0.4vh;
                }
                
                .upgrade-btn {
                    padding: 0.6vh 1.2vw;
                    font-size: 2.5vw !important;
                    min-height: 3.5vh !important;
                    border-radius: 1.2vw;
                }
                
                .level-display {
                    font-size: 2.2vw !important;
                }
            }
            
            @media (min-width: 400px) and (max-width: 480px) {
                #ui {
                    min-height: 70px !important;
                    max-height: 100px !important;
                }
                
                .info-label {
                    font-size: 2.5vw !important;
                }
                
                .info-value {
                    font-size: 2.8vw !important;
                }
                
                .panel-title {
                    font-size: 2.8vw !important;
                }
                
                .upgrade-btn {
                    font-size: 2.2vw !important;
                    min-height: 3.2vh !important;
                }
                
                .level-display {
                    font-size: 1.9vw !important;
                }
            }
        }
        
        /* 横屏模式优化 */
        @media (max-width: 768px) and (orientation: landscape) {
            /* 欢迎界面横屏优化 */
            #welcomeScreen {
                padding: 10px 20px;
                justify-content: center;
            }
            
            .welcome-title {
                font-size: 24px;
                margin-bottom: 10px;
            }
            
            .mode-selection {
                flex-direction: row !important; /* 横屏时强制水平排列 */
                gap: 10px;
                margin-bottom: 15px;
                justify-content: space-between;
            }
            
            .mode-btn {
                flex: 1 !important;
                padding: 8px 6px !important;
                font-size: 14px !important;
                min-width: 0 !important;
            }
            
            .color-selection {
                margin-bottom: 15px;
            }
            
            .color-title {
                font-size: 16px;
                margin-bottom: 8px;
            }
            
            .start-btn {
                padding: 8px 25px;
                font-size: 16px;
            }
            
            /* 横屏游戏UI - 强制水平排列，减少高度 */
            #ui {
                height: 8vh !important;
                min-height: 60px !important;
                max-height: 80px !important;
            }
            
            #ui.game-active {
                display: flex !important;
            }
            
            .mobile-ui-container {
                flex-direction: row !important; /* 横屏强制水平排列 */
            }
            
            .info-panel {
                flex: 0 0 30% !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .upgrade-panel {
                flex: 0 0 68% !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .upgrade-buttons-container {
                display: flex !important;
                flex-direction: column !important;
            }
            
            .upgrade-buttons-row {
                display: flex !important;
            }
            
            .upgrade-btn {
                font-size: 1.8vw !important;
                padding: 0.4vh 0.6vw;
                min-height: 2.5vh !important;
            }
            
            .info-label {
                font-size: 1.8vw !important;
            }
            
            .info-value {
                font-size: 2vw !important;
                min-width: 5vw;
            }
            
            .info-max {
                font-size: 1.6vw !important;
            }
            
            .panel-title {
                font-size: 2vw !important;
                margin-bottom: 0.3vh;
            }
            
            .level-display {
                font-size: 1.5vw !important;
            }
        }
        

    </style>
</head>
<body>
    <!-- 加载页面 -->
    <div id="loadingScreen">
        <div class="loading-container">
            <div class="loading-logo">Tiny Galaxy Clash</div>
            <div class="loading-text" id="loadingText">正在初始化游戏</div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-percentage" id="progressPercentage">0%</div>
            <div class="loading-details" id="loadingDetails">准备加载资源...</div>
        </div>
    </div>

    <!-- 欢迎界面 -->
    <div id="welcomeScreen">
        <!-- 设置按钮 -->
        <div class="settings-btn" id="settingsBtn" title="游戏设置">
            ⚙️
        </div>
        
        <h1 class="welcome-title">Tiny Galaxy Clash</h1>
        
        <div class="mode-selection">
            <button class="mode-btn" data-mode="1v1">1v1 对战</button>
            <button class="mode-btn" data-mode="2v2">2v2 团队</button>
            <button class="mode-btn" data-mode="ffa">混战模式</button>
        </div>
        
        <div class="color-selection">
            <div class="color-title">选择你的无人机颜色</div>
            <div class="color-options">
                <div class="color-btn selected" data-color="#00ff00" style="background: #00ff00;"></div>
                <div class="color-btn" data-color="#0099ff" style="background: #0099ff;"></div>
                <div class="color-btn" data-color="#ff0000" style="background: #ff0000;"></div>
                <div class="color-btn" data-color="#ffba00" style="background: #ffba00;"></div>
            </div>
        </div>
        
        <div class="color-selection">
            <div class="color-title">选择 AI 难度</div>
            <div class="mode-selection">
                <button class="mode-btn selected" data-difficulty="easy">简单</button>
                <button class="mode-btn" data-difficulty="medium">中等</button>
                <button class="mode-btn" data-difficulty="hard">困难</button>
            </div>
        </div>
        
        <button class="start-btn" id="startGame" disabled>开始游戏</button>
        
        <!-- 加载提示 -->
        <div class="loading-hint" id="loadingHint">正在加载游戏资源...</div>
        
        <!-- 预览按钮 -->
        <div class="preview-section">
            <button class="preview-btn" id="previewAssets">🎨 预览游戏素材</button>
        </div>
    </div>
    
    <!-- 设置弹窗 -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-panel">
            <h2 class="settings-title">🎵 游戏设置</h2>
            
            <div class="setting-item">
                <label class="setting-label">🎵 背景音乐</label>
                <div class="setting-controls">
                    <div class="toggle-switch active" id="bgMusicToggle">
                        <div class="toggle-slider"></div>
                    </div>
                    <input type="range" class="volume-slider" id="bgMusicVolume" min="0" max="100" value="50">
                    <span class="volume-value" id="bgMusicValue">50%</span>
                </div>
            </div>
            
            <div class="setting-item">
                <label class="setting-label">🔫 游戏音效</label>
                <div class="setting-controls">
                    <div class="toggle-switch active" id="soundEffectToggle">
                        <div class="toggle-slider"></div>
                    </div>
                    <input type="range" class="volume-slider" id="soundEffectVolume" min="0" max="100" value="70">
                    <span class="volume-value" id="soundEffectValue">70%</span>
                </div>
            </div>
            
            <button class="close-btn" id="closeSettings">关闭设置</button>
        </div>
    </div>
    
    <!-- 音频元素 -->
    <audio id="bgMusic" loop preload="auto" src="assets/audio/background.mp3">
        您的浏览器不支持音频播放
    </audio>
    
    <audio id="shootSound" preload="auto" src="assets/audio/shoot.mp3">
        您的浏览器不支持音频播放
    </audio>
    
    <!-- 游戏界面 -->
    <canvas id="gameCanvas" width="1200" height="800"></canvas>
    
    <!-- 投降确认弹窗 -->
    <div id="surrenderModal" class="surrender-modal">
        <div class="surrender-overlay"></div>
        <div class="surrender-dialog">
            <div class="surrender-title">投降确认</div>
            <div class="surrender-message">确定要投降吗？<br>投降后游戏将立即结束。</div>
            <div class="surrender-buttons">
                <button class="surrender-confirm-btn" id="confirmSurrender">确认投降</button>
                <button class="surrender-cancel-btn" id="cancelSurrender">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 暂停弹窗 -->
    <div id="pauseModal" class="pause-modal">
        <div class="pause-overlay"></div>
        <div class="pause-dialog">
            <div class="pause-title">游戏已暂停</div>
            <div class="pause-timer" id="pauseTimer">暂停时间: 00:00</div>
            <div class="pause-buttons">
                <button class="pause-resume-btn" id="resumeGame">继续游戏</button>
            </div>
        </div>
    </div>
    
    <div id="ui">
        <div class="mobile-ui-container">
            <!-- 基础信息面板 -->
            <div class="info-panel">
                <div class="info-row">
                    <span class="info-label">资源</span>
                    <span class="info-value highlight" id="resources">0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">无人机</span>
                    <span class="info-value" id="droneCount">20</span><span class="info-max">/30</span>
                </div>
                <div class="info-row">
                    <span class="info-label">击杀</span>
                    <span class="info-value highlight" id="killCount">0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">时间</span>
                    <span class="info-value" id="gameTime">00:00</span>
                </div>
            </div>
            
            <!-- 无人机升级面板 -->
            <div class="upgrade-panel drone-upgrade-panel">
                <div class="panel-title">无人机</div>
                <div class="upgrade-buttons-container">
                    <div class="upgrade-buttons-row">
                        <button class="upgrade-btn" id="upgradeAttack">攻击力 <span class="level-display">Lv.<span id="attackLevel">0</span></span></button>
                        <button class="upgrade-btn" id="upgradeSpeed">攻速 <span class="level-display">Lv.<span id="speedLevel">0</span></span></button>
                    </div>
                    <div class="upgrade-buttons-row">
                        <button class="upgrade-btn" id="upgradeMoveSpeed">移速 <span class="level-display">Lv.<span id="moveSpeedLevel">0</span></span></button>
                        <button class="upgrade-btn" id="upgradeHealth">血量 <span class="level-display">Lv.<span id="healthLevel">0</span></span></button>
                    </div>
                </div>
            </div>
            
            <!-- 基地升级面板 -->
            <div class="upgrade-panel base-upgrade-panel">
                <div class="panel-title">基地</div>
                <div class="upgrade-buttons-container">
                    <button class="upgrade-btn" id="upgradeBase">基地血量 <span class="level-display">Lv.<span id="baseLevel">0</span></span></button>
                </div>
            </div>
            
            <!-- 游戏控制面板 -->
            <div class="upgrade-panel game-control-panel">
                <div class="upgrade-buttons-container">
                    <button class="control-btn pause-btn" id="pauseGame">
                        <span class="pause-icon">⏸️</span>
                        <span class="pause-text">暂停</span>
                    </button>
                    <button class="control-btn surrender-btn" id="surrenderGame">
                        <span class="surrender-icon">🏳️</span>
                        <span class="surrender-text">投降</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 移除独立的gameInfo，已合并到ui中 -->
    
    <script>
        // 资源加载管理器
        class ResourceLoader {
            constructor() {
                this.resources = [];
                this.loadedCount = 0;
                this.totalCount = 0;
                this.onProgress = null;
                this.onComplete = null;
                
                // UI 元素
                this.loadingScreen = document.getElementById('loadingScreen');
                this.progressBar = document.getElementById('progressBar');
                this.progressPercentage = document.getElementById('progressPercentage');
                this.loadingText = document.getElementById('loadingText');
                this.loadingDetails = document.getElementById('loadingDetails');
            }
            
            // 添加图片资源
            addImage(src, name) {
                this.resources.push({
                    type: 'image',
                    src: src,
                    name: name,
                    loaded: false
                });
                this.totalCount++;
            }
            
            // 添加音频资源
            addAudio(src, name) {
                this.resources.push({
                    type: 'audio',
                    src: src,
                    name: name,
                    loaded: false
                });
                this.totalCount++;
            }
            
            // 添加脚本资源
            addScript(src, name) {
                this.resources.push({
                    type: 'script',
                    src: src,
                    name: name,
                    loaded: false
                });
                this.totalCount++;
            }
            
            // 开始加载所有资源
            async loadAll() {
                this.updateProgress(0, '开始加载资源...');
                
                // 并行加载所有资源
                const promises = this.resources.map(resource => this.loadResource(resource));
                
                try {
                    await Promise.all(promises);
                    this.updateProgress(100, '加载完成！');
                    
                    // 延迟一点时间让用户看到100%
                    setTimeout(() => {
                        this.hideLoadingScreen();
                        if (this.onComplete) this.onComplete();
                    }, 500);
                } catch (error) {
                    console.error('资源加载失败:', error);
                    this.updateProgress(100, '加载完成（部分资源可能失败）');
                    setTimeout(() => {
                        this.hideLoadingScreen();
                        if (this.onComplete) this.onComplete();
                    }, 500);
                }
            }
            
            // 加载单个资源
            loadResource(resource) {
                return new Promise((resolve, reject) => {
                    switch (resource.type) {
                        case 'image':
                            this.loadImage(resource, resolve, reject);
                            break;
                        case 'audio':
                            this.loadAudio(resource, resolve, reject);
                            break;
                        case 'script':
                            this.loadScript(resource, resolve, reject);
                            break;
                        default:
                            resolve();
                    }
                });
            }
            
            // 加载图片
            loadImage(resource, resolve, reject) {
                const img = new Image();
                
                img.onload = () => {
                    resource.loaded = true;
                    resource.element = img;
                    this.onResourceLoaded(resource);
                    resolve(img);
                };
                
                img.onerror = () => {
                    console.warn(`图片加载失败: ${resource.src}`);
                    resource.loaded = false;
                    this.onResourceLoaded(resource);
                    resolve(); // 即使失败也继续
                };
                
                img.src = resource.src;
            }
            
            // 加载音频
            loadAudio(resource, resolve, reject) {
                const audio = new Audio();
                
                const onCanPlay = () => {
                    resource.loaded = true;
                    resource.element = audio;
                    this.onResourceLoaded(resource);
                    cleanup();
                    resolve(audio);
                };
                
                const onError = () => {
                    console.warn(`音频加载失败: ${resource.src}`);
                    resource.loaded = false;
                    this.onResourceLoaded(resource);
                    cleanup();
                    resolve(); // 即使失败也继续
                };
                
                const cleanup = () => {
                    audio.removeEventListener('canplaythrough', onCanPlay);
                    audio.removeEventListener('error', onError);
                };
                
                audio.addEventListener('canplaythrough', onCanPlay);
                audio.addEventListener('error', onError);
                audio.preload = 'auto';
                audio.src = resource.src;
            }
            
            // 加载脚本
            loadScript(resource, resolve, reject) {
                const script = document.createElement('script');
                
                script.onload = () => {
                    resource.loaded = true;
                    resource.element = script;
                    this.onResourceLoaded(resource);
                    resolve(script);
                };
                
                script.onerror = () => {
                    console.warn(`脚本加载失败: ${resource.src}`);
                    resource.loaded = false;
                    this.onResourceLoaded(resource);
                    resolve(); // 即使失败也继续
                };
                
                script.src = resource.src;
                document.head.appendChild(script);
            }
            
            // 资源加载完成回调
            onResourceLoaded(resource) {
                this.loadedCount++;
                const progress = Math.round((this.loadedCount / this.totalCount) * 100);
                const statusText = resource.loaded ? '✓' : '✗';
                this.updateProgress(progress, `${statusText} ${resource.name}`);
                
                if (this.onProgress) {
                    this.onProgress(progress, this.loadedCount, this.totalCount);
                }
            }
            
            // 更新进度显示
            updateProgress(percentage, details) {
                if (this.progressBar) {
                    this.progressBar.style.width = percentage + '%';
                }
                if (this.progressPercentage) {
                    this.progressPercentage.textContent = percentage + '%';
                }
                if (this.loadingDetails && details) {
                    this.loadingDetails.textContent = details;
                }
            }
            
            // 隐藏加载页面
            hideLoadingScreen() {
                if (this.loadingScreen) {
                    this.loadingScreen.classList.add('hidden');
                    setTimeout(() => {
                        this.loadingScreen.style.display = 'none';
                    }, 500);
                }
            }
        }
        
        // 初始化资源加载
        function initializeGame() {
            const loader = new ResourceLoader();
            
            // 添加需要预加载的资源
            loader.addImage('assets/images/backgrounds/space_background.jpg', '欢迎界面背景');
            loader.addImage('assets/images/backgrounds/game_background.jpg', '游戏背景');
            loader.addImage('assets/images/ship_explosion.png', '爆炸特效');
            loader.addAudio('assets/audio/background.mp3', '背景音乐');
            loader.addAudio('assets/audio/shoot.mp3', '射击音效');
            loader.addScript('game.js', '游戏核心脚本');
            
            // 设置加载完成回调
            loader.onComplete = () => {
                console.log('🎮 所有资源加载完成，游戏准备就绪！');
                
                // 初始化游戏
                setTimeout(() => {
                    initializeGameAfterLoading();
                }, 100);
            };
            
            // 设置进度回调
            loader.onProgress = (percentage, loaded, total) => {
                console.log(`加载进度: ${percentage}% (${loaded}/${total})`);
            };
            
            // 开始加载
            loader.loadAll();
        }
        
        // 资源加载完成后的游戏初始化
        function initializeGameAfterLoading() {
            // 显示欢迎界面
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.add('show');
            
            // 预加载背景图片（现在应该已经加载完成）
            preloadBackgroundImage();
            
            // 初始化游戏实例
            try {
                window.game = new DroneGame();
                console.log('✅ 游戏初始化成功');
            } catch (error) {
                console.error('❌ 游戏初始化失败:', error);
                
                // 显示错误信息
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:red;color:white;padding:20px;border-radius:10px;z-index:9999;';
                errorDiv.textContent = '游戏初始化失败: ' + error.message;
                document.body.appendChild(errorDiv);
            }
        }
        
        // 页面加载完成后开始资源加载
        document.addEventListener('DOMContentLoaded', initializeGame);

        // 背景图预加载优化
        function preloadBackgroundImage() {
            const img = new Image();
            const welcomeScreen = document.getElementById('welcomeScreen');
            const loadingHint = document.getElementById('loadingHint');
            
            img.onload = function() {
                // 图片加载完成后添加背景
                welcomeScreen.classList.add('bg-loaded');
                // 隐藏加载提示
                if (loadingHint) {
                    loadingHint.classList.add('hidden');
                    setTimeout(() => {
                        loadingHint.style.display = 'none';
                    }, 500);
                }
            };
            
            img.onerror = function() {
                // 如果图片加载失败，使用渐变背景
                welcomeScreen.style.background = 'linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #16213e 100%)';
                // 隐藏加载提示
                if (loadingHint) {
                    loadingHint.textContent = '使用默认背景';
                    setTimeout(() => {
                        loadingHint.classList.add('hidden');
                        setTimeout(() => {
                            loadingHint.style.display = 'none';
                        }, 500);
                    }, 1000);
                }
            };
            
            // 开始预加载
            img.src = 'assets/images/backgrounds/space_background.jpg';
        }
        
        // 页面加载完成后立即预加载背景图
        document.addEventListener('DOMContentLoaded', preloadBackgroundImage);
        
        // 音频管理系统
        class AudioManager {
            constructor() {
                this.bgMusic = document.getElementById('bgMusic');
                this.shootSound = document.getElementById('shootSound');
                
                // 调试音频元素
                console.log('背景音乐元素:', this.bgMusic);
                console.log('射击音效元素:', this.shootSound);
                
                // 创建音效池 - 恢复到5个并发播放
                this.shootSoundPool = [];
                this.maxConcurrentSounds = 5;
                this.currentSoundIndex = 0;
                
                // 音效队列系统 - 串行播放
                this.soundQueue = [];
                this.isProcessingQueue = false;
                
                // 音效延迟系统
                this.lastSoundTime = 0;
                this.soundDelay = 50; // 50毫秒延迟间隔
                
                // 初始化音效池
                this.initSoundPool();
                
                // 监听音频加载事件
                if (this.shootSound) {
                    console.log('射击音效初始状态:', {
                        src: this.shootSound.src,
                        currentSrc: this.shootSound.currentSrc,
                        readyState: this.shootSound.readyState
                    });
                    
                    this.shootSound.addEventListener('loadstart', () => console.log('🔄 开始加载射击音效'));
                    this.shootSound.addEventListener('canplay', () => console.log('✅ 射击音效可以播放'));
                    this.shootSound.addEventListener('canplaythrough', () => console.log('✅ 射击音效完全加载'));
                    this.shootSound.addEventListener('error', (e) => console.log('❌ 射击音效加载错误:', e));
                    this.shootSound.addEventListener('loadeddata', () => console.log('📊 射击音效数据加载完成'));
                    
                    // 强制加载音频
                    this.shootSound.load();
                }
                
                // 默认设置
                this.settings = {
                    bgMusicEnabled: true,
                    bgMusicVolume: 0.5,
                    soundEffectEnabled: true,
                    soundEffectVolume: 0.5
                };
                
                // 从本地存储加载设置
                this.loadSettings();
                this.initAudio();
                this.initSettingsUI();
            }
            
            initSoundPool() {
                // 等待原音频加载完成后再创建音效池
                if (!this.shootSound) {
                    console.log('原音频元素不存在，无法创建音效池');
                    return;
                }
                
                // 如果音频还没加载完成，等待加载
                if (this.shootSound.readyState < 2) {
                    console.log('等待音频加载完成后创建音效池...');
                    this.shootSound.addEventListener('canplay', () => {
                        this.createSoundPool();
                    }, { once: true });
                } else {
                    this.createSoundPool();
                }
            }
            
            createSoundPool() {
                console.log('开始创建音效池...');
                this.shootSoundPool = []; // 重置音效池
                
                // 确保设置已初始化
                if (!this.settings || typeof this.settings.soundEffectVolume === 'undefined') {
                    console.log('设置未初始化，使用默认音量');
                    this.settings = this.settings || {};
                    this.settings.soundEffectVolume = 0.5; // 默认音量50%
                }
                
                // 创建音效池，每个都是原音频的克隆
                for (let i = 0; i < this.maxConcurrentSounds; i++) {
                    try {
                        const soundClone = this.shootSound.cloneNode();
                        soundClone.volume = this.settings.soundEffectVolume || 0.5; // 添加默认值保护
                        soundClone.preload = 'auto';
                        
                        this.shootSoundPool.push({
                            audio: soundClone,
                            isPlaying: false
                        });
                    } catch (error) {
                        console.log(`创建音效池第${i}个实例失败:`, error);
                    }
                }
                console.log(`音效池创建完成，支持${this.shootSoundPool.length}个并发播放`);
            }
            
            initAudio() {
                if (this.bgMusic) {
                    this.bgMusic.volume = this.settings.bgMusicVolume;
                }
                if (this.shootSound) {
                    this.shootSound.volume = this.settings.soundEffectVolume;
                }
            }
            
            initSettingsUI() {
                // 设置按钮事件
                const settingsBtn = document.getElementById('settingsBtn');
                const settingsModal = document.getElementById('settingsModal');
                const closeSettings = document.getElementById('closeSettings');
                
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', () => {
                        settingsModal.style.display = 'flex';
                    });
                }
                
                if (closeSettings) {
                    closeSettings.addEventListener('click', () => {
                        settingsModal.style.display = 'none';
                    });
                }
                
                // 点击弹窗外部关闭
                if (settingsModal) {
                    settingsModal.addEventListener('click', (e) => {
                        if (e.target === settingsModal) {
                            settingsModal.style.display = 'none';
                        }
                    });
                }
                
                // 背景音乐开关
                const bgMusicToggle = document.getElementById('bgMusicToggle');
                if (bgMusicToggle) {
                    bgMusicToggle.classList.toggle('active', this.settings.bgMusicEnabled);
                    bgMusicToggle.addEventListener('click', () => {
                        this.settings.bgMusicEnabled = !this.settings.bgMusicEnabled;
                        bgMusicToggle.classList.toggle('active', this.settings.bgMusicEnabled);
                        this.updateBgMusic();
                        this.saveSettings();
                    });
                }
                
                // 背景音乐音量
                const bgMusicVolume = document.getElementById('bgMusicVolume');
                const bgMusicValue = document.getElementById('bgMusicValue');
                if (bgMusicVolume && bgMusicValue) {
                    bgMusicVolume.value = this.settings.bgMusicVolume * 100;
                    bgMusicValue.textContent = Math.round(this.settings.bgMusicVolume * 100) + '%';
                    
                    bgMusicVolume.addEventListener('input', (e) => {
                        this.settings.bgMusicVolume = e.target.value / 100;
                        bgMusicValue.textContent = e.target.value + '%';
                        if (this.bgMusic) {
                            this.bgMusic.volume = this.settings.bgMusicVolume;
                        }
                        this.saveSettings();
                    });
                }
                
                // 音效开关
                const soundEffectToggle = document.getElementById('soundEffectToggle');
                if (soundEffectToggle) {
                    soundEffectToggle.classList.toggle('active', this.settings.soundEffectEnabled);
                    soundEffectToggle.addEventListener('click', () => {
                        this.settings.soundEffectEnabled = !this.settings.soundEffectEnabled;
                        soundEffectToggle.classList.toggle('active', this.settings.soundEffectEnabled);
                        this.saveSettings();
                    });
                }
                
                // 音效音量
                const soundEffectVolume = document.getElementById('soundEffectVolume');
                const soundEffectValue = document.getElementById('soundEffectValue');
                if (soundEffectVolume && soundEffectValue) {
                    soundEffectVolume.value = (this.settings.soundEffectVolume || 0.5) * 100;
                    soundEffectValue.textContent = Math.round((this.settings.soundEffectVolume || 0.5) * 100) + '%';
                    
                    soundEffectVolume.addEventListener('input', (e) => {
                        this.settings.soundEffectVolume = e.target.value / 100;
                        soundEffectValue.textContent = e.target.value + '%';
                        
                        // 更新原音频和音频池的音量
                        if (this.shootSound) {
                            this.shootSound.volume = this.settings.soundEffectVolume || 0.5;
                        }
                        
                        // 更新音频池中所有音频的音量
                        if (this.shootSoundPool) {
                            this.shootSoundPool.forEach(soundObj => {
                                if (soundObj && soundObj.audio) {
                                    soundObj.audio.volume = this.settings.soundEffectVolume || 0.5;
                                }
                            });
                        }
                        
                        this.saveSettings();
                    });
                }
            }
            
            startBgMusic() {
                if (this.bgMusic && this.settings.bgMusicEnabled) {
                    // 设置初始音量为0，准备渐变
                    this.bgMusic.volume = 0;
                    
                    // 尝试自动播放
                    const playPromise = this.bgMusic.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            // 播放成功，开始音量渐变
                            this.fadeInMusic();
                        }).catch(error => {
                            console.log('背景音乐自动播放被阻止，将在用户交互后播放');
                            // 添加用户交互监听器
                            this.setupAutoPlay();
                        });
                    }
                }
            }
            
            fadeInMusic() {
                if (!this.bgMusic || !this.settings.bgMusicEnabled) return;
                
                const targetVolume = this.settings.bgMusicVolume;
                const fadeSteps = 30; // 渐变步数
                const fadeInterval = 100; // 每步间隔100ms，总共3秒
                const volumeStep = targetVolume / fadeSteps;
                
                let currentStep = 0;
                const fadeTimer = setInterval(() => {
                    currentStep++;
                    const newVolume = Math.min(volumeStep * currentStep, targetVolume);
                    this.bgMusic.volume = newVolume;
                    
                    if (currentStep >= fadeSteps || newVolume >= targetVolume) {
                        clearInterval(fadeTimer);
                        this.bgMusic.volume = targetVolume; // 确保最终音量正确
                    }
                }, fadeInterval);
            }
            
            setupAutoPlay() {
                // 简单的用户交互监听器
                let hasPlayed = false;
                
                const tryPlayMusic = () => {
                    if (hasPlayed || !this.settings.bgMusicEnabled) return;
                    
                    this.bgMusic.volume = 0; // 从0开始
                    this.bgMusic.play().then(() => {
                        hasPlayed = true;
                        this.fadeInMusic(); // 开始渐变
                        // 移除监听器
                        document.removeEventListener('click', tryPlayMusic);
                        document.removeEventListener('touchstart', tryPlayMusic);
                        document.removeEventListener('keydown', tryPlayMusic);
                    }).catch(() => {
                        // 静默失败
                    });
                };
                
                // 监听用户交互
                document.addEventListener('click', tryPlayMusic);
                document.addEventListener('touchstart', tryPlayMusic);
                document.addEventListener('keydown', tryPlayMusic);
            }
            
            updateBgMusic() {
                if (!this.bgMusic) return;
                
                if (this.settings.bgMusicEnabled) {
                    if (this.bgMusic.paused) {
                        this.startBgMusic();
                    } else {
                        // 如果音乐正在播放，直接更新音量（不需要渐变）
                        this.bgMusic.volume = this.settings.bgMusicVolume;
                    }
                } else {
                    this.bgMusic.pause();
                }
            }
            
            stopBgMusic() {
                console.log('stopBgMusic被调用');
                if (this.bgMusic) {
                    console.log('暂停背景音乐');
                    this.bgMusic.pause();
                } else {
                    console.log('背景音乐元素未找到');
                }
            }
            
            // 新增：游戏中降低背景音乐音量
            lowerBgMusicForGame() {
                console.log('游戏开始，降低背景音乐音量');
                if (this.bgMusic && this.settings.bgMusicEnabled) {
                    const currentVolume = this.bgMusic.volume;
                    const targetVolume = Math.min(this.settings.bgMusicVolume, 0.07);
                    
                    console.log(`背景音乐音量从 ${currentVolume.toFixed(2)} 降低到 ${targetVolume.toFixed(2)}`);
                    
                    // 如果当前音量已经等于或小于目标音量，直接设置
                    if (currentVolume <= targetVolume) {
                        this.bgMusic.volume = targetVolume;
                        return;
                    }
                    
                    // 平滑过渡：2秒内从当前音量降低到目标音量
                    const fadeSteps = 20; // 渐变步数
                    const fadeInterval = 100; // 每步间隔100ms，总共2秒
                    const volumeStep = (currentVolume - targetVolume) / fadeSteps;
                    
                    let currentStep = 0;
                    const fadeTimer = setInterval(() => {
                        currentStep++;
                        const newVolume = Math.max(currentVolume - (volumeStep * currentStep), targetVolume);
                        this.bgMusic.volume = newVolume;
                        
                        if (currentStep >= fadeSteps || newVolume <= targetVolume) {
                            clearInterval(fadeTimer);
                            this.bgMusic.volume = targetVolume; // 确保最终音量正确
                            console.log(`背景音乐音量渐变完成: ${targetVolume.toFixed(2)}`);
                        }
                    }, fadeInterval);
                } else {
                    console.log('背景音乐未启用或元素未找到');
                }
            }
            
            // 新增：恢复背景音乐正常音量
            restoreBgMusicVolume() {
                console.log('恢复背景音乐正常音量');
                if (this.bgMusic && this.settings.bgMusicEnabled) {
                    const currentVolume = this.bgMusic.volume;
                    const targetVolume = this.settings.bgMusicVolume;
                    
                    console.log(`背景音乐音量从 ${currentVolume.toFixed(2)} 恢复到 ${targetVolume.toFixed(2)}`);
                    
                    // 如果当前音量已经等于目标音量，直接设置
                    if (Math.abs(currentVolume - targetVolume) < 0.01) {
                        this.bgMusic.volume = targetVolume;
                        return;
                    }
                    
                    // 平滑过渡：1.5秒内从当前音量恢复到目标音量
                    const fadeSteps = 15; // 渐变步数
                    const fadeInterval = 100; // 每步间隔100ms，总共1.5秒
                    const volumeStep = (targetVolume - currentVolume) / fadeSteps;
                    
                    let currentStep = 0;
                    const fadeTimer = setInterval(() => {
                        currentStep++;
                        const newVolume = Math.min(currentVolume + (volumeStep * currentStep), targetVolume);
                        this.bgMusic.volume = newVolume;
                        
                        if (currentStep >= fadeSteps || Math.abs(newVolume - targetVolume) < 0.01) {
                            clearInterval(fadeTimer);
                            this.bgMusic.volume = targetVolume; // 确保最终音量正确
                            console.log(`背景音乐音量恢复完成: ${targetVolume.toFixed(2)}`);
                        }
                    }, fadeInterval);
                } else {
                    console.log('背景音乐未启用或元素未找到');
                }
            }
            
            testShootSound() {
                console.log('=== 手动测试射击音效 ===');
                
                // 强制重新加载音频
                console.log('强制重新加载音频文件...');
                this.shootSound.src = '';
                this.shootSound.src = 'assets/audio/shoot.mp3';
                this.shootSound.load();
                
                // 添加详细的事件监听
                const onCanPlay = () => {
                    console.log('✅ 音频可以播放，尝试播放...');
                    this.playShootSound();
                    this.shootSound.removeEventListener('canplay', onCanPlay);
                };
                
                const onError = (e) => {
                    console.log('❌ 音频加载失败:', e);
                    console.log('音频文件可能不存在或格式不支持');
                };
                
                this.shootSound.addEventListener('canplay', onCanPlay);
                this.shootSound.addEventListener('error', onError);
                
                // 如果5秒后还没加载成功，尝试直接播放
                setTimeout(() => {
                    if (this.shootSound.readyState < 2) {
                        console.log('⚠️ 音频加载超时，尝试直接播放...');
                        this.playShootSound();
                    }
                }, 5000);
            }
            
            playShootSound() {
                if (!this.settings.soundEffectEnabled) {
                    return;
                }
                
                // 如果音效池不可用，使用原来的方式
                if (!this.shootSoundPool || this.shootSoundPool.length === 0) {
                    console.log('音效池不可用，使用原音频播放');
                    this.playOriginalSound();
                    return;
                }
                
                // 使用延迟播放避免同时播放
                this.playWithDelay();
            }
            
            playWithDelay() {
                const currentTime = Date.now();
                const timeSinceLastSound = currentTime - this.lastSoundTime;
                
                if (timeSinceLastSound < this.soundDelay) {
                    // 如果距离上次播放时间太短，延迟播放
                    const delayTime = this.soundDelay - timeSinceLastSound;
                    setTimeout(() => {
                        this.playFromPool();
                        this.lastSoundTime = Date.now();
                    }, delayTime);
                } else {
                    // 可以立即播放
                    this.playFromPool();
                    this.lastSoundTime = currentTime;
                }
            }
            
            playFromPool() {
                // 寻找可用的音频实例
                let availableSound = null;
                let playingCount = 0;
                
                for (let soundObj of this.shootSoundPool) {
                    if (soundObj.isPlaying) {
                        playingCount++;
                    } else if (!availableSound) {
                        availableSound = soundObj;
                    }
                }
                
                console.log(`音效池状态: ${playingCount}/${this.shootSoundPool.length} 正在播放`);
                
                if (availableSound) {
                    try {
                        const audio = availableSound.audio;
                        
                        // 设置音量并重置播放位置
                        audio.volume = this.settings.soundEffectVolume || 0.5;
                        audio.currentTime = 0;
                        
                        // 标记为正在播放
                        availableSound.isPlaying = true;
                        
                        // 播放音效
                        const playPromise = audio.play();
                        if (playPromise !== undefined) {
                            playPromise.then(() => {
                                console.log('音效开始播放（延迟播放）');
                                
                                // 播放成功，监听结束事件
                                const onEnded = () => {
                                    availableSound.isPlaying = false;
                                    audio.removeEventListener('ended', onEnded);
                                    console.log('音效播放结束');
                                };
                                
                                audio.addEventListener('ended', onEnded, { once: true });
                                
                                // 设置超时保护，防止事件不触发
                                setTimeout(() => {
                                    if (availableSound.isPlaying && (audio.ended || audio.paused)) {
                                        console.log('音效超时保护触发');
                                        availableSound.isPlaying = false;
                                        audio.removeEventListener('ended', onEnded);
                                    }
                                }, 2000); // 2秒超时保护
                                
                            }).catch(error => {
                                // 播放失败，重置状态
                                availableSound.isPlaying = false;
                                console.log('音效播放失败:', error);
                            });
                        } else {
                            // 旧版浏览器兼容
                            availableSound.isPlaying = false;
                            console.log('浏览器不支持Promise播放');
                        }
                    } catch (error) {
                        availableSound.isPlaying = false;
                        console.log('音效播放异常:', error);
                    }
                } else {
                    console.log('所有音效实例都在使用中，跳过此次播放');
                }
            }
            
            // 保留processNextSound方法以防其他地方调用，但改为空实现
            processNextSound() {
                // 不再使用队列系统，改为直接并发播放
                console.log('processNextSound已弃用，使用并发播放模式');
            }
            
            playOriginalSound() {
                // 备用播放方法，使用原音频
                if (this.shootSound) {
                    try {
                        this.shootSound.volume = this.settings.soundEffectVolume || 0.5;
                        this.shootSound.currentTime = 0;
                        
                        const playPromise = this.shootSound.play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                console.log('原音频播放失败:', error);
                            });
                        }
                    } catch (error) {
                        console.log('原音频播放异常:', error);
                    }
                }
            }
            
            saveSettings() {
                localStorage.setItem('gameAudioSettings', JSON.stringify(this.settings));
            }
            
            loadSettings() {
                const saved = localStorage.getItem('gameAudioSettings');
                if (saved) {
                    try {
                        this.settings = { ...this.settings, ...JSON.parse(saved) };
                    } catch (e) {
                        console.log('加载音频设置失败，使用默认设置');
                    }
                }
            }
        }
        
        // 初始化音频管理器
        let audioManager;
        document.addEventListener('DOMContentLoaded', () => {
            audioManager = new AudioManager();
            // 将audioManager设为全局变量，供game.js使用
            window.audioManager = audioManager;
            
            // 页面加载后尝试播放背景音乐
            setTimeout(() => {
                audioManager.startBgMusic();
            }, 1000);
        });
        
        // Web Audio API测试函数
        function testBeepSound() {
            console.log('=== 测试Web Audio API蜂鸣声 ===');
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // 800Hz频率
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // 30%音量
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2); // 播放0.2秒
                
                console.log('✅ Web Audio API蜂鸣声播放成功');
            } catch (error) {
                console.log('❌ Web Audio API测试失败:', error);
            }
        }
        
        // 页面加载时创建所有效果
        document.addEventListener('DOMContentLoaded', function() {
            // 移动端优化初始化
            initMobileOptimizations();
            
            // 预览按钮点击事件
            const previewBtn = document.getElementById('previewAssets');
            if (previewBtn) {
                previewBtn.addEventListener('click', function() {
                    window.open('preview.html', '_blank', 'width=1200,height=800');
                });
            }
        });
        
        // 移动端优化函数
        function initMobileOptimizations() {
            // 检测移动设备
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
            
            if (isMobile) {
                // 禁用移动端的一些默认行为
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault(); // 禁用多点触控缩放
                    }
                }, { passive: false });
                
                document.addEventListener('touchend', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                document.addEventListener('touchmove', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault(); // 禁用多点触控缩放
                    }
                }, { passive: false });
                
                // 禁用双击缩放
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                console.log('移动端优化已启用');
            }
            
            // 屏幕方向变化处理
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    // 延迟处理，等待方向变化完成
                    if (window.game && window.game.gameState === 'playing') {
                        window.game.setFullscreenCanvas();
                    }
                }, 100);
            });
        }
    </script>
</body>
</html>